<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sakhi Voice</title>
<meta name="description" content="Sakhi Voice ‚Äî photo avatar with pseudo lip-sync, splash logos, floating mic, multilingual TTS" />
<link rel="icon" href="./Sakhi_logo.png" />
<style>
  :root{--bg:#0b1020;--panel:#0f1733;--text:#e9eef9;--muted:#a8b5d9;--glass:rgba(255,255,255,.10);--accent:#e63946}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(80% 80% at 50% 20%, #16224b 0%, var(--bg) 55%);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

  /* Splash: Jio ‚Üí Sakhi */
  .splash{position:fixed;inset:0;display:grid;place-items:center;background:#000;z-index:9999;transition:opacity .6s ease}
  .splash-inner{display:flex;flex-direction:column;align-items:center;gap:24px}
  .splash img{width:160px;height:auto;opacity:0;transform:translateY(10px);transition:opacity .5s,transform .5s}
  .splash img.show{opacity:1;transform:translateY(0)}

  .wrap{min-height:100dvh;display:flex;flex-direction:column;gap:12px;padding:14px;max-width:680px;margin:0 auto}
  .card{background:linear-gradient(160deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--glass);
        border-radius:18px;padding:14px;box-shadow:0 10px 36px rgba(0,0,0,.35)}
  header{display:flex;align-items:center;gap:10px;padding-top:6px}
  header img{height:28px;width:auto;border-radius:6px}
  header h1{font-size:1.1rem;margin:0;font-weight:650;letter-spacing:.2px}

  /* Avatar panel */
  .avatar-panel{display:grid;gap:12px;grid-template-rows:auto auto}
  .stage{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--glass);
         background:linear-gradient(180deg,#24325f 0%,#1a2142 65%,#121a34 100%);display:grid;place-items:center;min-height:360px}
  .avatar.photo{position:relative;width:min(92%,520px);aspect-ratio:3/4;border-radius:18px;overflow:hidden;border:1px solid rgba(0,0,0,.06)}
  .avatar.photo .face{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center}
  .avatar.photo::after{content:"";position:absolute;inset:auto 0 0 0;height:35%;
    background:linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,.10) 60%, rgba(0,0,0,.18) 100%)}

  /* Mouth overlay (adjustable via sliders, saved per-device) */
  .mouth{
    position:absolute; left:50%; transform:translateX(-50%);
    width:var(--mw,16%); height:var(--mh,10px); top:var(--mtop,46%);
    background:#6d1b2a; border-radius:18px; box-shadow:inset 0 -3px 0 rgba(0,0,0,.25);
    transition:height .08s ease; mix-blend-mode:multiply;
  }
  .mouth.open{ height:calc(var(--mh-open,24px)); }

  /* Controls */
  .controls{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  select,textarea,button{background:var(--panel);color:var(--text);border:1px solid var(--glass);border-radius:12px;padding:10px 12px;font-size:.95rem}
  textarea{grid-column:1/-1;min-height:90px;resize:vertical}
  .primary{background:linear-gradient(90deg,#3d66ff,#7aa2ff);border:none;font-weight:700}
  .ghost{background:transparent}
  .presets{display:flex;flex-wrap:wrap;gap:8px}
  .preset{font-size:.8rem;padding:6px 10px;border-radius:999px;border:1px solid var(--glass);background:var(--panel);cursor:pointer}
  .muted{color:var(--muted)}

  /* Fit tool */
  details.fit{grid-column:1/-1;background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.12);border-radius:12px;padding:10px}
  .fit .row{display:flex;gap:10px;align-items:center}
  .fit label{font-size:.8rem;color:var(--muted);width:70px}
  .fit input[type="range"]{width:100%}
  .fit small{color:var(--muted)}

  /* Floating mic button + meter */
  .micFab{
    position:fixed; right:16px; bottom:16px; z-index:9998;
    display:flex; align-items:center; gap:10px;
    padding:10px 14px; border-radius:999px; border:1px solid var(--glass);
    background:rgba(15,23,51,.85); backdrop-filter:blur(6px);
    box-shadow:0 8px 24px rgba(0,0,0,.35)
  }
  .micFab button{
    background:transparent; color:var(--text); border:1px solid var(--glass);
    border-radius:999px; padding:8px 12px; font-weight:700; cursor:pointer
  }
  .micFab button.on{ border-color:#1dd75b; box-shadow:0 0 0 2px rgba(29,215,91,.25) inset }
  #micMeter{ width:74px; height:12px; background:#0b1020; border:1px solid var(--glass); border-radius:20px }
  @media (max-width:480px){ .micFab{ right:12px; bottom:12px } }
</style>
</head>
<body>
  <!-- Splash: Jio ‚Üí Sakhi -->
  <div class="splash" id="splash">
    <div class="splash-inner">
      <img id="logo-jio" src="./JIo_logo.png" alt="Jio" />
      <img id="logo-sakhi" src="./Sakhi_logo.png" alt="Sakhi" />
    </div>
  </div>

  <div class="wrap" aria-live="polite">
    <header class="card">
      <img src="./JIo_logo.png" alt="Jio" />
      <img src="./Sakhi_logo.png" alt="Sakhi" />
      <h1>Sakhi Voice ‚Äî Multilingual</h1>
    </header>

    <section class="card avatar-panel">
      <div class="stage">
        <div class="avatar photo" id="avatar">
          <img class="face" src="./sakhi-photo.jpg" alt="HR Sakhi" />
          <div id="mouth" class="mouth"></div>
        </div>
      </div>

      <div class="controls">
        <select id="lang">
          <option value="en-IN" selected>English (India)</option>
          <option value="hi-IN">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
          <option value="kn-IN">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
          <option value="mr-IN">Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
          <option value="ta-IN">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
          <option value="te-IN">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
          <option value="ml-IN">Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
          <option value="gu-IN">Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
          <option value="bn-IN">Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
          <option value="pa-IN">Punjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
        </select>

        <select id="voice"></select>

        <textarea id="text">Hi Deepa! I am HR Sakhi. How can I help you with maternity and E S I C today?</textarea>

        <button class="primary" id="speakBtn">‚ñ∂Ô∏è Speak</button>
        <button class="ghost" id="stopBtn">‚èπ Stop</button>

        <div class="presets" id="presets" style="grid-column:1/-1;margin-top:6px;"></div>
        <div class="muted" id="status" style="grid-column:1/-1;">Tip: Allow mic if prompted. The floating pill shows live input level.</div>

        <details class="fit">
          <summary>Adjust mouth fit</summary>
          <div class="row"><label>Top</label><input id="mtop" type="range" min="30" max="70" step="0.1"><small id="mtopv"></small></div>
          <div class="row"><label>Width</label><input id="mwidth" type="range" min="8" max="26" step="0.1"><small id="mwidthv"></small></div>
          <div class="row"><label>Closed</label><input id="mh" type="range" min="6" max="18" step="1"><small id="mhv"></small></div>
          <div class="row"><label>Open</label><input id="mhop" type="range" min="14" max="34" step="1"><small id="mhopv"></small></div>
          <div class="row"><button id="saveFit" class="primary">Save</button><button id="resetFit" class="ghost">Reset</button></div>
          <small>Saved per-device in your browser.</small>
        </details>
      </div>
    </section>

    <footer class="muted">¬© 2025 ‚Ä¢ Sakhi Voice ‚Ä¢ Demo only ¬∑ Uses browser speech (no server)</footer>
  </div>

  <!-- Floating mic toggle + level meter -->
  <div class="micFab" role="group" aria-label="Microphone controls">
    <canvas id="micMeter" width="74" height="12" aria-hidden="true"></canvas>
    <button id="micToggle" title="Mic On/Off">üéôÔ∏è Mic</button>
  </div>

<script>
  /* ================= Splash: Jio ‚Üí Sakhi ================= */
  const splash = document.getElementById('splash');
  const jio = document.getElementById('logo-jio');
  const sakhi = document.getElementById('logo-sakhi');
  setTimeout(()=> jio.classList.add('show'), 120);
  setTimeout(()=> { jio.classList.remove('show'); sakhi.classList.add('show'); }, 1500);
  setTimeout(()=> { splash.style.opacity = 0; setTimeout(()=> splash.style.display='none', 600); }, 2800);

  /* ================= TTS + pseudo lip-sync ================= */
  const synth = window.speechSynthesis;
  const langSel = document.getElementById('lang');
  const voiceSel = document.getElementById('voice');
  const textEl  = document.getElementById('text');
  const speakBtn= document.getElementById('speakBtn');
  const stopBtn = document.getElementById('stopBtn');
  const mouth   = document.getElementById('mouth');
  const presetsEl = document.getElementById('presets');
  const statusEl  = document.getElementById('status');

  let voices = [];
  let flapTimer = null;

  // Presets (10 languages). English mentions E S I C as letters.
  const SAMPLE_LINES = {
    "en-IN":"Hi Deepa! I am HR Sakhi. How can I help you with maternity and E S I C today?",
    "hi-IN":"‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‡§¶‡•Ä‡§™‡§æ! ‡§Æ‡•à‡§Ç ‡§è‡§ö‡§Ü‡§∞ ‡§∏‡§ñ‡•Ä ‡§π‡•Ç‡§Å‡•§ ‡§Æ‡§æ‡§§‡•É‡§§‡•ç‡§µ ‡§î‡§∞ ‡§à  ‡§è‡§∏  ‡§Ü‡§à  ‡§∏‡•Ä ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡•Ä ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•Ç‡§Å?",
    "kn-IN":"‡≤®‡≤Æ‡≤∏‡≥ç‡≤§‡≥Ü ‡≤¶‡≥Ä‡≤™‡≤æ! ‡≤®‡≤æ‡≤®‡≥Å HR ‡≤∏‡≤ñ‡≤ø. ‡≤Æ‡≥Ü‡≤ü‡≤∞‡≥ç‡≤®‡≤ø‡≤ü‡≤ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å E  S  I  C ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤®‡≤æ‡≤®‡≥Å ‡≤π‡≥á‡≤ó‡≥Ü ‡≤∏‡≤π‡≤æ‡≤Ø ‡≤Æ‡≤æ‡≤°‡≤≤‡≤ø?",
    "mr-IN":"‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ‡§¶‡•Ä‡§™‡§æ! ‡§Æ‡•Ä HR ‡§∏‡§ñ‡•Ä ‡§Ü‡§π‡•á. ‡§Æ‡§æ‡§§‡•É‡§§‡•ç‡§µ ‡§Ü‡§£‡§ø E  S  I  C ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠‡§æ‡§§ ‡§Æ‡•Ä ‡§ï‡§∂‡•Ä ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•Ç?",
    "ta-IN":"‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡Æ§‡ØÄ‡Æ™‡Ææ! ‡Æ®‡Ææ‡Æ©‡Øç HR ‡Æö‡Æï‡Æø. Maternity ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç E  S  I  C ‡Æï‡ØÅ‡Æ±‡Æø‡Æ§‡Øç‡Æ§‡ØÅ ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æâ‡Æ§‡Æµ‡Æ≤‡Ææ‡ÆÆ‡Øç?",
    "te-IN":"‡∞®‡∞Æ‡∞∏‡±ç‡∞§‡±á ‡∞¶‡±Ä‡∞™‡∞æ! ‡∞®‡±á‡∞®‡±Å HR ‡∞∏‡∞ñ‡∞ø. ‡∞Æ‡±á‡∞ü‡∞∞‡±ç‡∞®‡∞ø‡∞ü‡±Ä ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å E  S  I  C ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±ç‡∞≤‡±ã ‡∞®‡±á‡∞®‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ö‡±á‡∞Ø‡∞ó‡∞≤‡∞®‡±Å?",
    "ml-IN":"‡¥®‡¥Æ‡¥∏‡µç‚Äå‡¥ï‡¥æ‡¥∞‡¥Ç ‡¥¶‡µÄ‡¥™‡¥æ! ‡¥û‡¥æ‡µª HR ‡¥∏‡¥ñ‡¥ø. ‡¥Æ‡¥æ‡¥§‡µÉ‡¥§‡µç‡¥µ‡¥µ‡µÅ‡¥Ç E  S  I  C ‡¥µ‡¥ø‡¥∑‡¥Ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥∏‡¥Ç‡¥¨‡¥®‡µç‡¥ß‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥é‡¥ô‡µç‡¥ô‡¥®‡µÜ ‡¥∏‡¥π‡¥æ‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç?",
    "gu-IN":"‡™®‡™Æ‡™∏‡´ç‡™§‡´á ‡™¶‡´Ä‡™™‡™æ! ‡™π‡´Å‡™Ç HR ‡™∏‡™ñ‡´Ä ‡™õ‡´Å‡™Ç. ‡™Æ‡´á‡™ü‡™∞‡™®‡™ø‡™ü‡´Ä ‡™Ö‡™®‡´á E  S  I  C ‡¶¨‡¶ø‡¶∑‡ßü‡ßá ‡™π‡´Å‡™Ç ‡™ï‡´á‡™µ‡´Ä ‡™∞‡´Ä‡™§‡´á ‡™Æ‡™¶‡™¶ ‡™ï‡™∞‡´Ä ‡™∂‡™ï‡´Å‡™Ç?",
    "bn-IN":"‡¶®‡¶Æ‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶¶‡ßÄ‡¶™‡¶æ! ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶á‡¶ö‡¶Ü‡¶∞ ‡¶∏‡¶ñ‡ßÄ‡•§ ‡¶Æ‡¶æ‡¶§‡ßÉ‡¶§‡ßç‡¶¨ ‡¶è‡¶¨‡¶Ç E  S  I  C ‡¶¨‡¶ø‡¶∑‡ßü‡ßá ‡¶Ü‡¶Æ‡¶ø ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?",
    "pa-IN":"‡®∏‡®§ ‡®∏‡©ç‡®∞‡©Ä ‡®Ö‡®ï‡®æ‡®≤ ‡®¶‡©Ä‡®™‡®æ! ‡®Æ‡©à‡®Ç HR ‡®∏‡®ñ‡©Ä ‡®π‡®æ‡®Ç‡•§ ‡®Æ‡®æ‡®§‡®∞‡®§‡®µ ‡®Ö‡®§‡©á E  S  I  C ‡®¨‡®æ‡®∞‡©á ‡®Æ‡©à‡®Ç ‡®ï‡®ø‡®µ‡©á‡®Ç ‡®Æ‡®¶‡®¶ ‡®ï‡®∞ ‡®∏‡®ï‡®¶‡©Ä ‡®π‡®æ‡®Ç?"
  };

  // Prefer female EN-IN voices if available
  const FEMALE_HINTS=["female","zira","sonia","priya","aditi","meera","neural","susan","zaira","ananya","heli","asha","revathi","lakshmi"];

  function buildPresets(){
    presetsEl.innerHTML='';
    Object.entries(SAMPLE_LINES).forEach(([k,v])=>{
      const b=document.createElement('button');
      b.className='preset'; b.textContent=k; b.title=v;
      b.onclick=()=>{ langSel.value=k; populateVoices(); textEl.value=v; };
      presetsEl.appendChild(b);
    });
  }

  function loadVoices(){ voices = synth.getVoices(); populateVoices(); }
  function preferFemale(list){
    const enHint = list.find(v => (v.lang||'').toLowerCase().startsWith('en-in') && FEMALE_HINTS.some(h=>(v.name||'').toLowerCase().includes(h)));
    if(enHint) return enHint;
    const anyFemale = list.find(v => FEMALE_HINTS.some(h=>(v.name||'').toLowerCase().includes(h)));
    return anyFemale || list[0];
  }
  function populateVoices(){
    const lang=langSel.value.toLowerCase();
    voiceSel.innerHTML='';
    const primary=voices.filter(v=>v.lang && v.lang.toLowerCase().startsWith(lang));
    const fallback=voices.filter(v=>v.lang && v.lang.toLowerCase().startsWith(lang.split('-')[0]));
    const finalList=primary.length?primary:(fallback.length?fallback:voices);
    finalList.forEach(v=>{
      const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} ‚Äî ${v.lang}`; voiceSel.appendChild(opt);
    });
    if(finalList.length){ voiceSel.value = (preferFemale(finalList) || finalList[0]).name; }
  }
  speechSynthesis.onvoiceschanged = loadVoices; if(!voices.length)setTimeout(loadVoices,80);

  function startFlap(){ if(flapTimer)clearInterval(flapTimer); flapTimer=setInterval(()=>mouth.classList.toggle('open'), 120); }
  function stopFlap(){ if(flapTimer)clearInterval(flapTimer); mouth.classList.remove('open'); }

  function speak(text){
    // ensure ‚ÄúE S I C‚Äù is said as letters in ANY language by spacing letters in English segments
    const ensureLetters = (t) => t.replace(/ESIC|E\s*S\s*I\s*C/ig, 'E S I C');
    const t=(text ?? textEl.value ?? "").trim(); if(!t) return;
    if(synth.speaking) synth.cancel();
    const u=new SpeechSynthesisUtterance(ensureLetters(t));
    u.lang=langSel.value;
    const chosen=voices.find(v=>v.name===voiceSel.value); if(chosen) u.voice=chosen;
    // Gentler pace, female-ish pitch
    u.rate=0.95; u.pitch=1.05;

    u.onboundary=()=>{ mouth.classList.add('open'); setTimeout(()=>mouth.classList.remove('open'), 70); };
    u.onstart=startFlap; u.onend=stopFlap; u.onerror=stopFlap;
    synth.speak(u);
  }

  speakBtn.addEventListener('click',()=>speak());
  stopBtn.addEventListener('click',()=>{ if(synth.speaking) synth.cancel(); stopFlap(); });
  langSel.addEventListener('change',()=>{ populateVoices(); textEl.value=SAMPLE_LINES[langSel.value]||textEl.value; });

  /* ================= Floating Mic: toggle + meter + auto-restart recognition ================= */
  const micBtn = document.getElementById('micToggle');
  const meterCanvas = document.getElementById('micMeter');
  const mctx = meterCanvas.getContext('2d');

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = SR ? new SR() : null;
  let micOn = false;      // desired toggle
  let listening = false;  // SR state

  // Meter
  let audioCtx, analyser, micSource, rafId;
  const METER_BG = '#0b1020', METER_FG = '#1dd75b';
  function drawMeter(level=0){
    const w=meterCanvas.width, h=meterCanvas.height;
    mctx.clearRect(0,0,w,h);
    mctx.fillStyle=METER_BG; mctx.fillRect(0,0,w,h);
    const barW = Math.max(2, Math.min(w-2, Math.floor(level * (w-2))));
    mctx.fillStyle=METER_FG; mctx.fillRect(1,1, barW, h-2);
  }
  async function startMeter(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser(); analyser.fftSize=256;
      const source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser); micSource = source;
      const data = new Uint8Array(analyser.frequencyBinCount);
      const loop = ()=>{
        analyser.getByteTimeDomainData(data);
        let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum/data.length); drawMeter(rms* (micOn?1:0.2));
        rafId = requestAnimationFrame(loop);
      };
      loop();
    }catch(err){
      statusEl.textContent = 'Mic permission blocked. Click the padlock ‚Üí Site settings ‚Üí Microphone ‚Üí Allow.';
      drawMeter(0);
    }
  }
  function stopMeter(){
    if(rafId) cancelAnimationFrame(rafId);
    try{ if(audioCtx && audioCtx.state!=='closed') audioCtx.close(); }catch{}
    audioCtx = analyser = micSource = null;
    drawMeter(0);
  }

  // SpeechRecognition
  if(rec){
    rec.continuous = false;
    rec.interimResults = false;
    rec.lang = 'en-IN'; // default, we update it when language dropdown changes
    rec.onstart = ()=>{ listening = true; micBtn.classList.add('on'); micBtn.textContent='üéôÔ∏è Mic On'; statusEl.textContent='Listening‚Ä¶ speak now'; };
    rec.onend   = ()=>{ listening = false; micBtn.classList.remove('on'); micBtn.textContent = micOn ? 'üéôÔ∏è Mic On (restarting)' : 'üéôÔ∏è Mic Off';
                        if(micOn){ try{ rec.start(); }catch{} } };
    rec.onerror = (e)=>{ statusEl.textContent = 'Mic error: ' + (e.error||'Unknown'); };
    rec.onresult= (e)=>{
      const txt = (e.results[0] && e.results[0][0] && e.results[0][0].transcript) || '';
      statusEl.textContent = 'You said: ' + txt;
      speak(hrReply(txt));
    };
  } else {
    statusEl.textContent = 'Mic not supported here. Use Chrome.';
    micBtn.disabled = true;
  }

  function hrReply(q){
    const s=(q||'').toLowerCase();

    // Ensure ESIC always spoken as letters
    const sayESIC = 'E S I C';

    if(s.includes('maternity')){
      return 'HR Sakhi: For maternity benefits, please check your eligibility, handover plan, and apply at least eight weeks in advance. For ' + sayESIC + ' coverage, ensure your IP number is active.';
    }
    if(s.includes('e s i c') || s.includes('esic') || s.includes('e.s.i.c')){
      return 'HR Sakhi: ' + sayESIC + ' is the Employees State Insurance Corporation. I can help you with your IP number, dispensary details, and benefit claims.';
    }
    if(s.includes('leave')||s.includes('vacation')||s.includes('holiday')){
      return 'HR Sakhi: You can apply for leave in the myHR portal. For emergencies, inform your manager and submit within 24 hours.';
    }
    if(s.includes('policy')){
      return 'HR Sakhi: Latest policies are in the Policy Hub. I can send you the link.';
    }
    if(s.includes('benefit')||s.includes('insurance')||s.includes('medical')){
      return 'HR Sakhi: Benefits include health insurance, accident cover, and wellness support. Check the Benefits page for details.';
    }
    if(s.includes('salary')||s.includes('payslip')){
      return 'HR Sakhi: Payslips are available on the Payroll page on the last business day.';
    }
    if(s.includes('hello')||s.includes('hi')||s.includes('namaste')){
      return 'Hello Deepa! I am HR Sakhi. How can I help you today?';
    }
    return 'HR Sakhi: I heard "'+q+'". I can help with maternity, ' + sayESIC + ', leave, policies, benefits, or payroll.';
  }

  function setRecLangFromUI(){ if(rec) rec.lang = (langSel.value||'en-IN'); }
  langSel.addEventListener('change', setRecLangFromUI);

  async function toggleMic(force){
    const target = (typeof force==='boolean') ? force : !micOn;
    micOn = target;
    if(micOn){
      setRecLangFromUI();
      if(rec && !listening){ try{ rec.start(); }catch{} }
      await startMeter();
      micBtn.classList.add('on'); micBtn.textContent='üéôÔ∏è Mic On';
      statusEl.textContent='Mic is ON. Speak to HR Sakhi.';
    }else{
      if(rec && listening){ try{ rec.stop(); }catch{} }
      stopMeter();
      micBtn.classList.remove('on'); micBtn.textContent='üéôÔ∏è Mic Off';
      statusEl.textContent='Mic is OFF.';
    }
  }
  micBtn.addEventListener('click', ()=>toggleMic());

  // Fit controls (mouth placement)
  const fitKeys={mtop:'--mtop',mw:'--mw',mh:'--mh',mhop:'--mh-open'};
  const elTop=document.getElementById('mtop'), elW=document.getElementById('mwidth'), elH=document.getElementById('mh'), elHop=document.getElementById('mhop');
  const vTop=document.getElementById('mtopv'), vW=document.getElementById('mwidthv'), vH=document.getElementById('mhv'), vHop=document.getElementById('mhopv');
  const saveBtn=document.getElementById('saveFit'), resetBtn=document.getElementById('resetFit'); const avatar=document.getElementById('avatar');

  function applyFit(topPct,widthPct,closedPx,openPx){
    avatar.style.setProperty(fitKeys.mtop, topPct+'%');
    avatar.style.setProperty(fitKeys.mw, widthPct+'%');
    avatar.style.setProperty(fitKeys.mh, closedPx+'px');
    avatar.style.setProperty(fitKeys.mhop, openPx+'px');
    elTop.value=topPct; elW.value=widthPct; elH.value=closedPx; elHop.value=openPx;
    vTop.textContent=topPct+'%'; vW.textContent=widthPct+'%'; vH.textContent=closedPx+'px'; vHop.textContent=openPx+'px';
  }
  function loadFit(){
    const d=JSON.parse(localStorage.getItem('sakhi-fit')||'{}');
    applyFit(d.top??46, d.w??16, d.h??10, d.hop??24);
  }
  saveBtn.onclick=(e)=>{ e.preventDefault();
    localStorage.setItem('sakhi-fit', JSON.stringify({top:parseFloat(elTop.value), w:parseFloat(elW.value), h:parseInt(elH.value), hop:parseInt(elHop.value)}));
    statusEl.textContent='Saved mouth fit.';
  };
  resetBtn.onclick=(e)=>{ e.preventDefault(); localStorage.removeItem('sakhi-fit'); loadFit(); statusEl.textContent='Reset to defaults.'; };

  // Init sequence
  buildPresets();
  loadVoices();
  loadFit();
  // greeting that mentions E S I C letters
  setTimeout(()=>speak('Hi Deepa! I am HR Sakhi. How can I help you with maternity and E S I C today?'), 900);

  // Start mic ON by default (if permission allowed)
  (async ()=>{ await toggleMic(true); })();
</script>
</body>
</html>
