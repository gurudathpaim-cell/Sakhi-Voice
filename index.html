<doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Deepa — HR Sakhi</title>
<meta name="theme-color" content="#6b46c1">
<style>
  :root{
    --bg1:#faf7ff; --bg2:#efe9ff; --ink:#0f172a; --muted:#6b7280;
    --brand:#6b46c1; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}

  /* Corner logos */
  .logos{position:fixed;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:center;z-index:20;pointer-events:none}
  .logos img{height:40px;object-fit:contain;pointer-events:auto}
  .logos img.hide{display:none}

  /* Fullscreen avatar (auto-fit) */
  .stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  .avatar-wrap{position:relative;width:100vw;height:100vh;max-width:100%;max-height:100%}
  .avatar{position:absolute;inset:0}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}

  /* Soft professional lip-sync */
  .mouth{position:absolute;left:50%;bottom:11%;width:46px;height:10px;border-radius:12px;background:var(--brand);
         transform:translateX(-50%) scaleX(.85);opacity:.9;transition:height .09s ease}
  .talk-1{height:14px}.talk-2{height:18px}.talk-3{height:22px}

  /* Bottom control panel */
  .panel{position:fixed;left:0;right:0;bottom:0;padding:12px 14px;display:flex;flex-direction:column;gap:8px;
         background:linear-gradient(180deg,transparent,rgba(250,247,255,.95) 35%);z-index:15}
  .row{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  .btn{border:0;border-radius:999px;background:var(--brand);color:#fff;font-weight:700;padding:10px 14px;cursor:pointer}
  .btn.secondary{background:#111827}
  .ask{flex:1;min-width:240px;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px}
  .meter{height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .meter>i{display:block;height:100%;width:0;background:var(--ok);transition:width .12s}
  .status{font-size:12px;color:var(--muted);text-align:center}

  /* Minimal bubbles (optional tiny transcript) */
  .chat{max-height:24vh;overflow:auto;display:flex;flex-direction:column;gap:6px}
  .bub{align-self:center;max-width:min(92vw,820px);border-radius:12px;padding:6px 10px;font-size:14px}
  .me{background:#eef2ff}.ai{background:#ecfeff}

  /* Tap-to-start splash (unlocks audio/mic) */
  .splash{position:fixed;inset:0;background:rgba(255,255,255,.7);backdrop-filter:blur(6px);
          display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50}
  .pill{margin-top:14px;border:1px solid #d1d5db;border-radius:999px;background:#fff;padding:10px 14px;font-weight:700;cursor:pointer}

  @media (max-width:640px){ .logos img{height:32px} }
</style>
</head>
<body>

<!-- Logos (exact files from your repo) -->
<div class="logos" aria-hidden="true">
  <img src="Sakhi_logo.png" alt="Sakhi logo with original tagline" onerror="this.classList.add('hide')">
  <img src="Jio_logo.png"   alt="Jio logo (blue)"                 onerror="this.classList.add('hide')">
</div>

<!-- Full-screen avatar -->
<div class="stage" role="main" aria-label="Deepa — HR Sakhi">
  <div class="avatar-wrap">
    <div class="avatar">
      <img src="sakhi-photo.jpg" alt="Deepa — HR Sakhi">
      <div id="mouth" class="mouth"></div>
    </div>
  </div>
</div>

<!-- Tap-to-start (required by browsers) -->
<section id="splash" class="splash" aria-modal="true">
  <div style="font-size:20px;font-weight:900;color:#0f172a">Sakhi • Jio</div>
  <div style="font-size:13px;color:#334155">Your Digital HR Companion</div>
  <button id="tapStart" class="pill">Tap to start</button>
</section>

<!-- Controls (no process text visible) -->
<div class="panel" aria-live="polite">
  <div class="row">
    <button id="stopBtn" class="btn secondary">■ Stop</button>
    <input id="q" class="ask" placeholder="Ask (e.g., ESIC maternity steps)" autocomplete="off">
    <button id="askBtn" class="btn">Ask</button>
  </div>
  <div class="meter"><i id="mbar"></i></div>
  <div id="mstatus" class="status">Mic Off</div>
  <div id="chat" class="chat" aria-label="Conversation"></div>
</div>

<script>
/* ===== elements ===== */
const splash  = document.getElementById('splash');
const tapBtn  = document.getElementById('tapStart');
const mouth   = document.getElementById('mouth');
const mbar    = document.getElementById('mbar');
const mstatus = document.getElementById('mstatus');
const qInput  = document.getElementById('q');
const askBtn  = document.getElementById('askBtn');
const stopBtn = document.getElementById('stopBtn');
const chat    = document.getElementById('chat');

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec=null, ended=false, saidHRBP=false, lipTimer=0;

/* ===== ESIC knowledge (short & interactive) ===== */
const KB = {
  overview: "E S I C offers medical care and cash benefits for eligible employees—sickness, maternity, employment injury and dependants.",
  contrib:  "Contributions: Employer 3.25% and Employee 0.75% of wages; coverage typically up to ₹21,000 per month wages.",
  step1:    "Step 1: Inform your HRBP of intended maternity leave dates.",
  step2:    "Step 2: Visit the ESIC dispensary with your E-Pehchan Card and Medical Acceptance Card.",
  step3:    "Step 3: Log in to the ESIC IP portal — if first time, create your password.",
  step4:    "Step 4: Ensure at least 70 days contribution in the previous two contribution periods.",
  step5:    "Step 5: Collect and submit Forms 17, 18 and 19. Form 22 only if applicable.",
  step6:    "Step 6: Apply maternity leave in PeopleFirst as per dates on Form 18.",
  step7:    "Step 7: After delivery, submit proofs at the ESIC Branch Office within 45 days.",
  payment:  "Payment: E S I C pays 100% of average daily wages for up to 182 days."
};
const STEPS = [KB.step1,KB.step2,KB.step3,KB.step4,KB.step5,KB.step6,KB.step7,KB.payment];

/* ===== small helpers ===== */
function addBubble(who, text){
  const b=document.createElement('div'); b.className='bub '+(who==='me'?'me':'ai'); b.innerHTML=text;
  chat.appendChild(b); b.scrollIntoView({behavior:'smooth',block:'end'});
}
function setMeter(p){ mbar.style.width=Math.max(0,Math.min(100,p))+'%'; }
function setStatus(t){ mstatus.textContent=t; }

/* ===== voice: Indian female English; force E-S-I-C pronunciation ===== */
function pickVoice(){
  const vs=speechSynthesis.getVoices();
  // try common female Indian/English voices first
  return vs.find(v=>/Google UK English Female/i.test(v.name)) ||
         vs.find(v=>/en-IN/i.test(v.lang) && /female/i.test(v.name)) ||
         vs.find(v=>/en-IN/i.test(v.lang)) ||
         vs.find(v=>/English/i.test(v.lang)) ||
         vs[0];
}
function lipsyncStart(){
  clearInterval(lipTimer);
  let phase=0;
  lipTimer=setInterval(()=>{
    phase=(phase+1)%3;
    mouth.classList.remove('talk-1','talk-2','talk-3');
    mouth.classList.add(phase===0?'talk-1':phase===1?'talk-2':'talk-3');
  },110);
}
function lipsyncStop(){
  clearInterval(lipTimer);
  mouth.classList.remove('talk-1','talk-2','talk-3');
}
function speak(text){
  if(ended) return;
  const t=text.replace(/\bESIC\b/gi,'E S I C'); // force spelling
  const u=new SpeechSynthesisUtterance(t);
  u.voice=pickVoice(); u.rate=0.96; u.pitch=1.0;
  u.onstart=lipsyncStart; u.onend=lipsyncStop;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

/* ===== conversation router (short answers + offer next step) ===== */
let stepCursor=0;
function nextStep(){
  const s=STEPS[stepCursor++]; if(!s){ return "Those are the key steps. Do you want me to repeat anything?"; }
  return s+"  Shall I tell you the next step?";
}
function route(msg){
  const q=(msg||'').trim();
  const t=q.toLowerCase();

  if(/^(no|nope|not now|thank you|thanks|ok|okay|bye|bye now|that is all)$/.test(q)){
    ended=true; addBubble('ai','<b>Deepa:</b> Dhanyavaad.'); speak("Dhanyavaad."); return null;
  }

  const has=(...k)=>k.some(x=>t.includes(x));
  if(has('what is esic','what is e s i c','overview','benefit','benefits')) return KB.overview;
  if(has('contribution','rate','employee contribution','employer contribution','percentage','%')) return KB.contrib;
  if(has('document','docs','forms','form 17','form 18','form 19','form 22')) return "Key documents are Forms 17, 18 and 19, plus E-Pehchan, MAC, birth certificate, Aadhaar and bank details. Need the steps to submit?";
  if(has('step','process','apply','claim','how do i apply','how to apply','maternity leave')){
    return nextStep();
  }
  if(has('email','mail','send mail','send email','e-mail')){
    if(!saidHRBP){ saidHRBP=true; return "Please reach out to your HRBP for more information."; }
    return "I can guide you on E S I C here.";
  }
  if(!saidHRBP){ saidHRBP=true; return "Please reach out to your HRBP for more information."; }
  return "I can guide E S I C maternity steps, documents and payments. Ask about steps or documents.";
}

/* ===== speech recognition (auto listen + green bar) ===== */
const SRClass = SR;
let recActive=false;
function startRec(){
  if(!SRClass){ setStatus('Speech recognition not supported. Use Chrome.'); return; }
  try{ rec && rec.stop(); }catch(_){}
  rec=new SRClass(); rec.lang='en-IN'; rec.interimResults=true; rec.continuous=true;
  let buffer='', partial=''; recActive=true;
  setMeter(0); setStatus('Mic On — Listening…');

  rec.onresult=(e)=>{
    for(let i=e.resultIndex;i<e.results.length;i++){
      const txt=e.results[i][0].transcript;
      if(e.results[i].isFinal){ buffer+=txt+' '; } else { partial=txt; }
    }
    const wc=(buffer.trim()+' '+partial.trim()).split(/\s+/).filter(Boolean).length;
    setMeter(Math.min(100,Math.round(wc/12*100)));
  };
  rec.onerror=(ev)=>{
    recActive=false; setStatus('Mic Off — '+(ev.error||'error'));
    if(ev.error==='not-allowed'){ alert('Please enable microphone to use this application.'); }
  };
  rec.onend=()=>{
    recActive=false;
    const q=buffer.trim();
    if(!q){ setStatus('Mic Off'); setMeter(0); return; }
    addBubble('me','<b>You:</b> '+q);
    const a=route(q);
    if(a){ addBubble('ai','<b>Deepa:</b> '+a.replace(/E S I C/g,'ESIC')); speak(a); }
    if(!ended) setTimeout(()=>startRec(),350);
  };

  try{ rec.start(); }catch(e){ setStatus('Mic Off'); }
}
function stopRec(){
  try{ rec && rec.stop(); }catch(_){}
  recActive=false; setStatus('Mic Off'); setMeter(0); speechSynthesis.cancel();
}

/* ===== typed Ask ===== */
askBtn.onclick=()=>{
  const v=qInput.value.trim(); if(!v) return;
  addBubble('me','<b>You:</b> '+v);
  const a=route(v);
  if(a){ addBubble('ai','<b>Deepa:</b> '+a.replace(/E S I C/g,'ESIC')); speak(a); }
  qInput.value=''; if(!ended) setTimeout(()=>startRec(),350);
};

/* ===== first tap → greet → wait → fallback → auto-listen ===== */
tapBtn.onclick=()=>{
  splash.style.display='none';
  stepCursor=0; // reset steps each session
  const greet="Namaste, I am Deepa, your HR Sakhi. How can I help you today on E S I C maternity benefits?";
  addBubble('ai','<b>Deepa:</b> '+greet.replace(/E S I C/,'ESIC')); speak(greet);

  // If silent after 6s, offer to guide
  setTimeout(()=>{
    if(chat.querySelectorAll('.me').length===0 && !ended){
      const hint="I can help you with the process to avail the E S I C benefits — shall I guide you through it?";
      addBubble('ai','<b>Deepa:</b> '+hint.replace(/E S I C/,'ESIC')); speak(hint);
    }
  },6000);

  setTimeout(()=>startRec(),550);
};

/* ===== controls ===== */
stopBtn.onclick=stopRec;

/* ===== permissions reminder ===== */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible' && mstatus.textContent.includes('not-allowed')){
    alert('Please enable microphone: click the lock icon in the address bar → Site settings → Microphone → Allow.');
  }
});

/* preload voices */
window.speechSynthesis.onvoiceschanged=()=>{};
</script>
</body>
</html>
