<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sakhi Voice ‚Äî HR Assistant</title>
<link rel="icon" href="./Sakhi_logo.png" />
<style>
  :root{
    --bg1:#16224b; --bg2:#0b1020; --glass:rgba(255,255,255,.12);
    /* Mouth fit defaults (you can tweak from the Fit panel) */
    --mouth-top:62%;         /* % from top of avatar */
    --mouth-width:26%;       /* % of avatar width */
    --mouth-closed:6px;      /* height when closed */
    --mouth-open:18px;       /* height when open */
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Segoe UI",system-ui,Roboto,Arial,sans-serif;
    background:radial-gradient(circle at 50% -20%, var(--bg1), var(--bg2));
    color:#fff; display:flex; flex-direction:column; align-items:center; min-height:100vh;
  }
  header{
    width:100%; display:flex; justify-content:center; align-items:center; gap:10px; padding:10px 12px;
  }
  header img{height:32px}
  h2{margin:0}

  /* Avatar */
  .avatar{
    position:relative; width:min(70vw,260px); height:min(70vw,260px);
    border-radius:50%; overflow:hidden; margin-top:24px;
    box-shadow:0 10px 26px rgba(0,0,0,.35), 0 0 20px rgba(255,255,255,.12) inset;
    border:1px solid var(--glass);
    background:#0b1020;
  }
  .avatar img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
  /* subtle chin shading to help the mouth blend */
  .avatar::after{
    content:""; position:absolute; left:0; right:0; bottom:0; height:36%;
    background:linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,.10) 60%, rgba(0,0,0,.18) 100%);
    pointer-events:none;
  }
  /* Mouth overlay */
  .mouth{
    position:absolute; left:50%; transform:translateX(-50%);
    top:var(--mouth-top);
    width:var(--mouth-width);
    height:var(--mouth-closed);
    background:#6d1b2a; border-radius:18px;
    box-shadow:inset 0 -3px 0 rgba(0,0,0,.25);
    transition:height .08s ease;
    mix-blend-mode:multiply;
  }
  .mouth.open{ height:var(--mouth-open); }

  #response{
    margin:18px 12px 6px; max-width:92%; text-align:center; line-height:1.4;
  }
  .btns{display:flex; gap:10px; margin:8px 0 12px}
  button{
    padding:10px 16px; border:none; border-radius:10px; font-weight:600; cursor:pointer; color:#fff;
  }
  #speakBtn{ background:#4da3ff }
  #stopBtn { background:#3a3a3a }

  /* Floating mic */
  #micBtn{
    position:fixed; right:16px; bottom:16px; width:62px; height:62px; border-radius:50%;
    display:flex; align-items:center; justify-content:center; font-size:26px;
    color:#fff; background:#4da3ff; border:none; cursor:pointer;
    box-shadow:0 8px 24px rgba(0,0,0,.35), 0 0 14px rgba(77,163,255,.5);
  }
  #micBtn.on{ background:#00c851; box-shadow:0 8px 24px rgba(0,0,0,.35), 0 0 14px rgba(0,200,81,.6) }

  /* Fit mouth panel */
  details.fit{ margin:8px 12px 20px; width:min(680px,95%); background:rgba(255,255,255,.04);
    border:1px dashed var(--glass); border-radius:12px; padding:10px 12px; }
  .fit .row{ display:flex; align-items:center; gap:10px; margin:6px 0 }
  .fit label{ width:90px; font-size:.9rem; color:#cbd5ff }
  .fit input[type="range"]{ flex:1 }
  .muted{ color:#a8b5d9; font-size:.9rem }
</style>
</head>
<body>
  <header>
    <img src="./JIo_logo.png" alt="Jio">
    <img src="./Sakhi_logo.png" alt="Sakhi">
    <h2>HR Sakhi</h2>
  </header>

  <div class="avatar" id="avatar">
    <img src="./sakhi-photo.jpg" alt="Deepa ‚Äì HR Sakhi">
    <div id="mouth" class="mouth"></div>
  </div>

  <p id="response">Namaste! I am Deepa, your HR Sakhi. How can I help you with maternity and E S I C today?</p>

  <div class="btns">
    <button id="speakBtn">üîä Speak</button>
    <button id="stopBtn">‚èπ Stop</button>
  </div>

  <details class="fit">
    <summary>Fit mouth</summary>
    <div class="row"><label>Top</label>   <input id="rTop"   type="range" min="50" max="75" step="0.1"><span id="vTop"  class="muted"></span></div>
    <div class="row"><label>Width</label> <input id="rW"     type="range" min="16" max="40" step="0.1"><span id="vW"    class="muted"></span></div>
    <div class="row"><label>Closed</label><input id="rC"     type="range" min="4"  max="14" step="1"><span  id="vC"    class="muted"></span></div>
    <div class="row"><label>Open</label>  <input id="rO"     type="range" min="12" max="28" step="1"><span  id="vO"    class="muted"></span></div>
    <div class="row">
      <button id="saveFit" style="background:#4da3ff">Save</button>
      <button id="resetFit" style="background:#3a3a3a">Reset</button>
    </div>
    <div class="muted">Saved per-device in your browser.</div>
  </details>

  <button id="micBtn" class="on" title="Mic on/off">üéôÔ∏è</button>

<script>
  /* ================= Speech Synthesis helpers ================= */
  const synth = window.speechSynthesis;
  function ensureVoices(cb){ if(synth.getVoices().length) cb(); else speechSynthesis.onvoiceschanged = cb; }

  // Prefer Microsoft Neerja (en-IN), else any en-IN female-ish, else first
  function pickIndianFemale(){
    const voices = synth.getVoices();
    const neerja = voices.find(v => (v.name||'').toLowerCase().includes('neerja') && (v.lang||'').toLowerCase().startsWith('en-in'));
    if(neerja) return neerja;
    const enIn = voices.filter(v => (v.lang||'').toLowerCase().startsWith('en-in'));
    const femaleHint = ['female','neural','aditi','priya','meera','ananya','sonia','zara','asha','lakshmi','revathi'];
    const female = enIn.find(v => femaleHint.some(h => (v.name||'').toLowerCase().includes(h)));
    return female || enIn[0] || voices[0] || null;
  }

  function sayESICLetters(text){ return text.replace(/esic/ig,'E S I C').replace(/e\s*s\s*i\s*c/ig,'E S I C'); }

  function speak(text){
    const u = new SpeechSynthesisUtterance(sayESICLetters(text));
    u.lang = 'en-IN';
    const v = pickIndianFemale(); if(v) u.voice = v;
    u.rate = 0.97; u.pitch = 1.05;

    // Pseudo lip-sync
    const mouth = document.getElementById('mouth');
    let flap;
    u.onstart = ()=>{ flap = setInterval(()=> mouth.classList.toggle('open'), 120); };
    u.onboundary = ()=>{ mouth.classList.add('open'); setTimeout(()=> mouth.classList.remove('open'), 70); };
    u.onend = ()=>{ clearInterval(flap); mouth.classList.remove('open'); };
    u.onerror = ()=>{ clearInterval(flap); mouth.classList.remove('open'); };

    synth.cancel(); // stop anything else
    synth.speak(u);
  }

  /* ================= UI buttons ================= */
  const response = document.getElementById('response');
  document.getElementById('speakBtn').onclick = ()=> speak(response.textContent);
  document.getElementById('stopBtn').onclick = ()=> synth.cancel();

  /* ================= Mic: continuous recognition with recovery ================= */
  const micBtn = document.getElementById('micBtn');
  let rec, micOn = true, listening = false;

  function initRec(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Speech recognition not supported in this browser."); return; }
    rec = new SR();
    rec.lang = 'en-IN';
    rec.continuous = true;
    rec.interimResults = false;
    rec.maxAlternatives = 1;

    rec.onstart = ()=>{ listening=true; micBtn.classList.add('on'); };
    rec.onend   = ()=>{ listening=false; if(micOn) setTimeout(()=>{ try{ rec.start(); }catch{} }, 250); };
    rec.onerror = (e)=>{ if(['no-speech','audio-capture','network'].includes(e.error)){ if(micOn){ try{ rec.stop(); }catch{} } } };
    rec.onresult= (ev)=>{
      const txt = ev.results[ev.results.length-1][0].transcript;
      response.textContent = "You said: " + txt;
      replyTo(txt);
    };
  }

  micBtn.onclick = ()=>{
    if(!rec) initRec();
    micOn = !micOn;
    if(micOn){ micBtn.classList.add('on'); try{ rec.start(); }catch{} }
    else     { micBtn.classList.remove('on'); try{ rec.stop(); }catch{} }
  };

  function replyTo(q){
    const s = (q||'').toLowerCase();
    const ESIC = 'E S I C';
    let ans =
      s.includes('maternity') ? `Under ${ESIC}, maternity leave provides twenty six weeks of paid leave and full medical benefits.` :
      (s.includes('e s i c') || s.includes('esic')) ? `${ESIC} is the Employees State Insurance Corporation. I can help with your IP number, dispensary and claims.` :
      s.includes('leave') ? `Please raise leave in the myHR portal. For emergencies, inform your manager and submit within twenty four hours.` :
      `I am your HR Sakhi. Ask me about maternity benefits, ${ESIC}, leave, or policies.`;
    response.textContent = ans;
    speak(ans);
  }

  /* ================= Mouth fit save/load ================= */
  const avatar = document.getElementById('avatar');
  const rTop = document.getElementById('rTop'), rW = document.getElementById('rW'), rC = document.getElementById('rC'), rO = document.getElementById('rO');
  const vTop = document.getElementById('vTop'), vW = document.getElementById('vW'), vC = document.getElementById('vC'), vO = document.getElementById('vO');
  const saveFit = document.getElementById('saveFit'), resetFit = document.getElementById('resetFit');

  function applyFit(t,w,c,o){
    avatar.style.setProperty('--mouth-top', t+'%');
    avatar.style.setProperty('--mouth-width', w+'%');
    avatar.style.setProperty('--mouth-closed', c+'px');
    avatar.style.setProperty('--mouth-open', o+'px');
    rTop.value=t; rW.value=w; rC.value=c; rO.value=o;
    vTop.textContent=t+'%'; vW.textContent=w+'%'; vC.textContent=c+'px'; vO.textContent=o+'px';
  }
  function loadFit(){
    const d = JSON.parse(localStorage.getItem('sakhi-mouth-fit')||'{}');
    applyFit(d.top ?? 62, d.w ?? 26, d.c ?? 6, d.o ?? 18);
  }
  saveFit.onclick = (e)=>{ e.preventDefault();
    localStorage.setItem('sakhi-mouth-fit', JSON.stringify({top:+rTop.value, w:+rW.value, c:+rC.value, o:+rO.value}));
  };
  resetFit.onclick = (e)=>{ e.preventDefault(); localStorage.removeItem('sakhi-mouth-fit'); loadFit(); };

  rTop.oninput=()=>applyFit(+rTop.value,+rW.value,+rC.value,+rO.value);
  rW.oninput  =()=>applyFit(+rTop.value,+rW.value,+rC.value,+rO.value);
  rC.oninput  =()=>applyFit(+rTop.value,+rW.value,+rC.value,+rO.value);
  rO.oninput  =()=>applyFit(+rTop.value,+rW.value,+rC.value,+rO.value);

  /* ================= Init ================= */
  ensureVoices(()=> speak("Namaste! I am Deepa, your HR Sakhi. How can I help you with E S I C today?"));
  loadFit();
  initRec();
  // Turn mic on initially (browser will prompt permission)
  try{ rec && rec.start(); }catch{}
</script>
</body>
</html>
